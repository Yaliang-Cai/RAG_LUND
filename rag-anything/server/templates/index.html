<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAG Notebook</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=IBM+Plex+Sans:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/marked@4.3.0/marked.min.js" onerror="loadFallbackMarked()"></script>
  <script>
    function loadFallbackMarked() {
      console.warn("CDN load failed, using plain text mode");
      window.marked = { parse: function(t) { return '<pre style="white-space:pre-wrap;">' + t + '</pre>'; } };
    }
    window.addEventListener('DOMContentLoaded', () => { if (typeof marked === 'undefined') loadFallbackMarked(); });
  </script>
  <style>
    /* ══════════════════════════════════════════════
       DESIGN SYSTEM — Editorial Research Journal
       Warm document reader + Dark chat interface
       Amber accent palette
    ══════════════════════════════════════════════ */

    :root {
      /* Amber accent system */
      --accent: #d4940a;
      --accent-soft: rgba(212, 148, 10, 0.12);
      --accent-medium: rgba(212, 148, 10, 0.25);
      --accent-glow: rgba(212, 148, 10, 0.06);

      /* Typography */
      --font-display: 'DM Serif Display', Georgia, serif;
      --font-body: 'IBM Plex Sans', -apple-system, sans-serif;
      --font-mono: 'IBM Plex Mono', 'Cascadia Code', monospace;

      /* Shared */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --transition: 180ms cubic-bezier(.4,0,.2,1);
      --divider-width: 5px;
    }

    /* ── Dark Theme (default) ── */
    [data-theme="dark"] {
      --bg-app: #111113;
      --bg-header: #19191c;
      --bg-source: #1c1b18;
      --bg-source-list: #1a1917;
      --bg-reader: #22211d;
      --bg-chat: #141416;
      --bg-input: #1e1e21;
      --bg-user-msg: #2a2520;
      --bg-bot-msg: #1c1c1f;
      --bg-hover: rgba(255,255,255,0.04);
      --bg-active: var(--accent-soft);
      --bg-code: #1a1a1d;
      --border: rgba(255,255,255,0.07);
      --border-strong: rgba(255,255,255,0.12);
      --text-primary: #e8e4df;
      --text-secondary: #9b9590;
      --text-tertiary: #6b6560;
      --text-reader: #d5d0c8;
      --text-reader-h: #f0ece6;
      --shadow-divider: 2px 0 12px rgba(0,0,0,0.3);
      --scrollbar-track: transparent;
      --scrollbar-thumb: rgba(255,255,255,0.1);
      --citation-bg: rgba(212, 148, 10, 0.15);
      --flash-color: rgba(212, 148, 10, 0.2);
      --thinking-dot: var(--accent);
      --input-border: rgba(255,255,255,0.1);
      --input-focus: var(--accent);
      --placeholder: #5a5550;
      --table-stripe: rgba(255,255,255,0.02);
      --img-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    /* ── Light Theme ── */
    [data-theme="light"] {
      --bg-app: #f5f2ed;
      --bg-header: #fffdf8;
      --bg-source: #faf8f3;
      --bg-source-list: #f7f5f0;
      --bg-reader: #fffef9;
      --bg-chat: #f0ede7;
      --bg-input: #ffffff;
      --bg-user-msg: #fff8eb;
      --bg-bot-msg: #ffffff;
      --bg-hover: rgba(0,0,0,0.03);
      --bg-active: var(--accent-soft);
      --bg-code: #f7f5f0;
      --border: rgba(0,0,0,0.08);
      --border-strong: rgba(0,0,0,0.14);
      --text-primary: #2c2824;
      --text-secondary: #7a7268;
      --text-tertiary: #a09890;
      --text-reader: #3a352e;
      --text-reader-h: #1a1612;
      --shadow-divider: 2px 0 12px rgba(0,0,0,0.06);
      --scrollbar-track: transparent;
      --scrollbar-thumb: rgba(0,0,0,0.12);
      --citation-bg: rgba(212, 148, 10, 0.12);
      --flash-color: rgba(212, 148, 10, 0.15);
      --thinking-dot: var(--accent);
      --input-border: rgba(0,0,0,0.12);
      --input-focus: var(--accent);
      --placeholder: #b0a898;
      --table-stripe: rgba(0,0,0,0.02);
      --img-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    /* ══════════════════════════════════════════════
       RESET & BASE
    ══════════════════════════════════════════════ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-body);
      background: var(--bg-app);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
    ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-medium); }

    /* ══════════════════════════════════════════════
       HEADER
    ══════════════════════════════════════════════ */
    header {
      height: 52px;
      background: var(--bg-header);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      justify-content: space-between;
      flex-shrink: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      user-select: none;
    }

    .brand-icon {
      width: 28px;
      height: 28px;
      background: var(--accent);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #fff;
      font-weight: 600;
      font-family: var(--font-mono);
      letter-spacing: -0.5px;
    }

    .brand-text {
      font-family: var(--font-display);
      font-size: 17px;
      color: var(--text-primary);
      letter-spacing: 0.2px;
    }

    .header-sep {
      width: 1px;
      height: 24px;
      background: var(--border-strong);
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ctrl-input {
      font-family: var(--font-mono);
      font-size: 12px;
      padding: 6px 10px;
      border: 1px solid var(--input-border);
      border-radius: var(--radius-sm);
      background: var(--bg-input);
      color: var(--text-primary);
      outline: none;
      transition: border-color var(--transition);
      width: 140px;
    }
    .ctrl-input:focus { border-color: var(--input-focus); }
    .ctrl-input::placeholder { color: var(--placeholder); }

    .ctrl-select {
      font-family: var(--font-body);
      font-size: 12px;
      padding: 6px 28px 6px 10px;
      border: 1px solid var(--input-border);
      border-radius: var(--radius-sm);
      background: var(--bg-input);
      color: var(--text-primary);
      outline: none;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%239b9590'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      min-width: 160px;
      transition: border-color var(--transition);
    }
    .ctrl-select:focus { border-color: var(--input-focus); }

    .header-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition);
      font-size: 15px;
    }
    .icon-btn:hover {
      background: var(--bg-hover);
      color: var(--accent);
      border-color: var(--accent-medium);
    }

    .theme-btn svg { width: 16px; height: 16px; fill: currentColor; }

    /* ══════════════════════════════════════════════
       MAIN LAYOUT
    ══════════════════════════════════════════════ */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    /* ── Source Panel (Left) ── */
    .source-panel {
      width: 48%;
      min-width: 300px;
      background: var(--bg-source);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
      transition: opacity 0.3s ease;
    }

    .source-list-header {
      padding: 12px 18px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: var(--text-tertiary);
      border-bottom: 1px solid var(--border);
      background: var(--bg-source-list);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .source-list-hint {
      font-size: 10px;
      font-weight: 400;
      text-transform: none;
      letter-spacing: 0;
      color: var(--text-tertiary);
      opacity: 0.7;
    }

    .source-list-container {
      max-height: 28vh;
      overflow-y: auto;
      border-bottom: 1px solid var(--border);
      padding: 6px;
      flex-shrink: 0;
    }

    .source-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 400;
      color: var(--text-secondary);
      transition: all var(--transition);
      gap: 10px;
    }
    .source-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    .source-item.active {
      background: var(--bg-active);
      color: var(--accent);
      font-weight: 500;
    }

    .source-icon {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 10px;
      color: var(--accent);
    }

    .source-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ── Document Reader ── */
    .markdown-content {
      flex: 1;
      overflow-y: auto;
      padding: 36px 40px 60px;
      background: var(--bg-reader);
      color: var(--text-reader);
      font-size: 15px;
      line-height: 1.8;
      font-weight: 300;
    }

    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3 {
      font-family: var(--font-display);
      color: var(--text-reader-h);
      font-weight: 400;
      margin-top: 2em;
      margin-bottom: 0.6em;
    }
    .markdown-content h1 {
      font-size: 1.8em;
      border-bottom: 2px solid var(--border-strong);
      padding-bottom: 12px;
      margin-top: 0;
    }
    .markdown-content h2 { font-size: 1.4em; }
    .markdown-content h3 { font-size: 1.15em; }

    .markdown-content p { margin-bottom: 1em; }

    .markdown-content a {
      color: var(--accent);
      text-decoration: none;
      border-bottom: 1px solid var(--accent-medium);
      transition: border-color var(--transition);
    }
    .markdown-content a:hover { border-color: var(--accent); }

    .markdown-content img {
      max-width: 100%;
      border-radius: var(--radius-md);
      margin: 16px 0;
      box-shadow: var(--img-shadow);
    }

    .markdown-content pre {
      background: var(--bg-code);
      padding: 16px 20px;
      border-radius: var(--radius-md);
      overflow-x: auto;
      border: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 13px;
      line-height: 1.6;
      margin: 16px 0;
    }

    .markdown-content code {
      font-family: var(--font-mono);
      font-size: 0.88em;
      background: var(--bg-code);
      padding: 2px 6px;
      border-radius: 4px;
    }
    .markdown-content pre code {
      background: transparent;
      padding: 0;
    }

    .markdown-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 16px 0;
      font-size: 0.9em;
    }
    .markdown-content th {
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--border-strong);
      padding: 8px 14px;
      color: var(--text-reader-h);
    }
    .markdown-content td {
      border-bottom: 1px solid var(--border);
      padding: 8px 14px;
    }
    .markdown-content tr:nth-child(even) td { background: var(--table-stripe); }

    .markdown-content blockquote {
      border-left: 3px solid var(--accent);
      padding: 8px 16px;
      margin: 16px 0;
      color: var(--text-secondary);
      background: var(--accent-glow);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }

    .markdown-content ul, .markdown-content ol {
      padding-left: 24px;
      margin-bottom: 1em;
    }
    .markdown-content li { margin-bottom: 4px; }

    .reader-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-tertiary);
      gap: 12px;
    }
    .reader-empty-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--accent);
      opacity: 0.6;
    }
    .reader-empty-title { font-family: var(--font-display); font-size: 16px; }
    .reader-empty-sub { font-size: 12px; opacity: 0.6; }

    /* ── Resizable Divider ── */
    .divider {
      width: var(--divider-width);
      cursor: col-resize;
      background: var(--border);
      position: relative;
      flex-shrink: 0;
      z-index: 10;
      transition: background var(--transition);
    }
    .divider::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 3px;
      height: 40px;
      border-radius: 2px;
      background: var(--text-tertiary);
      opacity: 0.3;
      transition: opacity var(--transition), height var(--transition);
    }
    .divider:hover { background: var(--accent-medium); }
    .divider:hover::after { opacity: 0.6; height: 56px; }
    .divider.dragging { background: var(--accent); }

    /* ── Chat Panel (Right) ── */
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-chat);
      min-width: 360px;
      overflow: hidden;
    }

    .chat-header {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .chat-header-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: var(--text-tertiary);
    }
    .chat-status {
      font-size: 10px;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .chat-welcome {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 10px;
      color: var(--text-tertiary);
      text-align: center;
    }
    .chat-welcome-icon {
      font-size: 28px;
      opacity: 0.4;
      margin-bottom: 4px;
    }
    .chat-welcome-title {
      font-family: var(--font-display);
      font-size: 18px;
      color: var(--text-secondary);
    }
    .chat-welcome-sub { font-size: 12px; opacity: 0.6; max-width: 260px; line-height: 1.6; }

    /* Messages */
    .message {
      max-width: 82%;
      padding: 14px 18px;
      border-radius: var(--radius-lg);
      line-height: 1.7;
      font-size: 14px;
      word-wrap: break-word;
      animation: msgIn 0.3s cubic-bezier(.4,0,.2,1);
    }

    @keyframes msgIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      align-self: flex-end;
      background: var(--bg-user-msg);
      border: 1px solid var(--accent-medium);
      border-bottom-right-radius: 4px;
      color: var(--text-primary);
    }

    .message.bot {
      align-self: flex-start;
      background: var(--bg-bot-msg);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
      color: var(--text-primary);
    }

    .message.bot p { margin-bottom: 8px; }
    .message.bot p:last-child { margin-bottom: 0; }
    .message.bot ul, .message.bot ol { padding-left: 20px; margin-bottom: 8px; }
    .message.bot li { margin-bottom: 2px; }
    .message.bot pre {
      background: var(--bg-code);
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      overflow-x: auto;
      font-family: var(--font-mono);
      font-size: 12px;
      margin: 8px 0;
      border: 1px solid var(--border);
    }
    .message.bot code {
      font-family: var(--font-mono);
      font-size: 0.88em;
      background: var(--bg-code);
      padding: 1px 5px;
      border-radius: 3px;
    }
    .message.bot pre code { background: transparent; padding: 0; }
    .message.bot table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.9em;
      margin: 8px 0;
    }
    .message.bot th, .message.bot td {
      border: 1px solid var(--border);
      padding: 6px 10px;
      text-align: left;
    }

    .message.thinking {
      background: transparent;
      border: none;
      padding: 8px 0;
    }

    .thinking-dots {
      display: flex;
      gap: 5px;
      align-items: center;
      padding: 4px 0;
    }
    .thinking-dots span {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--thinking-dot);
      opacity: 0.3;
      animation: dotPulse 1.4s ease-in-out infinite;
    }
    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes dotPulse {
      0%, 80%, 100% { opacity: 0.2; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1); }
    }

    /* Citation */
    .citation-link {
      color: var(--accent);
      cursor: pointer;
      font-weight: 600;
      background: var(--citation-bg);
      padding: 1px 6px;
      border-radius: 4px;
      font-size: 0.85em;
      font-family: var(--font-mono);
      transition: all var(--transition);
      border: 1px solid transparent;
    }
    .citation-link:hover {
      border-color: var(--accent-medium);
      background: var(--accent-medium);
    }

    /* Input Area */
    .input-area {
      padding: 16px 20px 20px;
      background: var(--bg-chat);
      flex-shrink: 0;
    }

    .input-wrapper {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      background: var(--bg-input);
      border: 1px solid var(--input-border);
      border-radius: var(--radius-lg);
      padding: 10px 12px 10px 16px;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .input-wrapper:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .input-wrapper textarea {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 14px;
      line-height: 1.5;
      resize: none;
      outline: none;
      min-height: 22px;
      max-height: 120px;
    }
    .input-wrapper textarea::placeholder { color: var(--placeholder); }

    .send-btn {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-sm);
      border: none;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition);
      flex-shrink: 0;
    }
    .send-btn:hover { filter: brightness(1.1); transform: scale(1.04); }
    .send-btn:active { transform: scale(0.96); }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
    .send-btn svg { width: 18px; height: 18px; fill: currentColor; }

    .input-hint {
      text-align: center;
      font-size: 10px;
      color: var(--text-tertiary);
      margin-top: 8px;
      opacity: 0.5;
    }

    /* ══════════════════════════════════════════════
       FLASH HIGHLIGHT
    ══════════════════════════════════════════════ */
    @keyframes flashHighlight {
      0% { box-shadow: inset 0 0 0 2px var(--accent), 0 0 20px var(--flash-color); }
      100% { box-shadow: none; }
    }
    .flash-active { animation: flashHighlight 1.5s ease-out; }

    /* ══════════════════════════════════════════════
       LOADING STATE
    ══════════════════════════════════════════════ */
    .file-list-empty {
      padding: 20px;
      text-align: center;
      font-size: 13px;
      color: var(--text-tertiary);
    }

    /* ══════════════════════════════════════════════
       PAGE LOAD ANIMATION
    ══════════════════════════════════════════════ */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    header { animation: fadeInUp 0.4s ease both; }
    .source-panel { animation: fadeInUp 0.4s ease 0.1s both; }
    .chat-panel { animation: fadeInUp 0.4s ease 0.2s both; }

    /* ══════════════════════════════════════════════
       RESPONSIVE
    ══════════════════════════════════════════════ */
    @media (max-width: 768px) {
      .main-container { flex-direction: column; }
      .source-panel { width: 100% !important; max-height: 45vh; min-width: 0; }
      .divider { width: 100%; height: 4px; cursor: row-resize; }
      .divider::after { width: 40px; height: 3px; }
      .chat-panel { min-width: 0; }
      .markdown-content { padding: 20px; }
    }
  </style>
</head>
<body>

  <!-- ═══ HEADER ═══ -->
  <header>
    <div class="header-left">
      <div class="brand">
        <div class="brand-icon">R</div>
        <div class="brand-text">RAG Notebook</div>
      </div>
      <div class="header-sep"></div>
      <div class="header-controls">
        <input type="password" id="apiKey" placeholder="API Key" class="ctrl-input" autocomplete="off">
        <button class="icon-btn" onclick="refreshWorkspaces()" title="Refresh workspaces">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M3.5 12a9 9 0 0 1 15-6.7L21.5 8"/><path d="M20.5 12a9 9 0 0 1-15 6.7L2.5 16"/></svg>
        </button>
        <select id="workspaceSelect" class="ctrl-select" onchange="loadWorkspace()">
          <option value="">Enter API key to start</option>
        </select>
      </div>
    </div>
    <div class="header-right">
      <button class="icon-btn theme-btn" onclick="toggleTheme()" title="Toggle theme">
        <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
      </button>
    </div>
  </header>

  <!-- ═══ MAIN CONTAINER ═══ -->
  <div class="main-container">

    <!-- Source Panel -->
    <div class="source-panel" id="sourcePanel">
      <div class="source-list-header">
        <span>Sources</span>
        <span class="source-list-hint">Select to preview</span>
      </div>
      <div class="source-list-container" id="fileList">
        <div class="file-list-empty">Select a workspace above</div>
      </div>
      <div class="markdown-content" id="markdownContainer">
        <div class="reader-empty">
          <div class="reader-empty-icon">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          </div>
          <div class="reader-empty-title">Document Preview</div>
          <div class="reader-empty-sub">Select a source file to view its content</div>
        </div>
      </div>
    </div>

    <!-- Resizable Divider -->
    <div class="divider" id="divider"></div>

    <!-- Chat Panel -->
    <div class="chat-panel">
      <div class="chat-header">
        <span class="chat-header-title">Assistant</span>
        <span class="chat-status">
          <span class="status-dot"></span>
          Ready
        </span>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-welcome">
          <div class="chat-welcome-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          </div>
          <div class="chat-welcome-title">Ask anything</div>
          <div class="chat-welcome-sub">Select a workspace and start asking questions about your documents</div>
        </div>
      </div>
      <div class="input-area">
        <div class="input-wrapper">
          <textarea id="questionInput" placeholder="Ask about the selected workspace..." rows="1"></textarea>
          <button class="send-btn" onclick="sendMessage()" id="sendBtn" title="Send message">
            <svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
          </button>
        </div>
        <div class="input-hint">Enter to send &middot; Shift + Enter for new line</div>
      </div>
    </div>
  </div>

  <!-- ═══ SCRIPTS ═══ -->
  <script>
    /* ── State ── */
    let currentDocId = "";
    let currentFilename = "";
    let messageSeq = 0;
    let welcomeCleared = false;

    /* ── Theme ── */
    function toggleTheme() {
      const html = document.documentElement;
      const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      localStorage.setItem('rag-theme', next);
    }
    (function initTheme() {
      const saved = localStorage.getItem('rag-theme');
      if (saved) document.documentElement.setAttribute('data-theme', saved);
    })();

    /* ── Resizable Divider ── */
    (function initDivider() {
      const divider = document.getElementById('divider');
      const sourcePanel = document.getElementById('sourcePanel');
      const container = document.querySelector('.main-container');
      let isDragging = false;

      divider.addEventListener('mousedown', (e) => {
        isDragging = true;
        divider.classList.add('dragging');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const rect = container.getBoundingClientRect();
        const pct = ((e.clientX - rect.left) / rect.width) * 100;
        const clamped = Math.max(20, Math.min(75, pct));
        sourcePanel.style.width = clamped + '%';
      });

      document.addEventListener('mouseup', () => {
        if (!isDragging) return;
        isDragging = false;
        divider.classList.remove('dragging');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
      });
    })();

    /* ── Auto-resize textarea ── */
    (function initTextarea() {
      const textarea = document.getElementById('questionInput');
      textarea.addEventListener('input', () => {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
      });
      textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    })();

    /* ── Helpers ── */
    function setWorkspacePlaceholder(text, disabled = true) {
      const s = document.getElementById("workspaceSelect");
      s.innerHTML = `<option value="">${text}</option>`;
      s.disabled = disabled;
    }

    function resetWorkspaceView(msg = "Select a workspace above") {
      currentDocId = "";
      currentFilename = "";
      document.getElementById("fileList").innerHTML = `<div class="file-list-empty">${msg}</div>`;
      document.getElementById("markdownContainer").innerHTML = `
        <div class="reader-empty">
          <div class="reader-empty-icon">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          </div>
          <div class="reader-empty-title">Document Preview</div>
          <div class="reader-empty-sub">Select a source file to view its content</div>
        </div>`;
    }

    /* ── API Calls ── */
    async function refreshWorkspaces() {
      const apiKey = document.getElementById("apiKey").value.trim();
      if (!apiKey) {
        setWorkspacePlaceholder("Enter API key to start");
        resetWorkspaceView();
        return;
      }
      resetWorkspaceView();
      setWorkspacePlaceholder("Loading...", true);
      try {
        const resp = await fetch("/workspaces", { headers: { "x-api-key": apiKey } });
        if (!resp.ok) {
          setWorkspacePlaceholder(resp.status === 401 ? "Invalid API key" : `Error (${resp.status})`);
          return;
        }
        const data = await resp.json();
        const s = document.getElementById("workspaceSelect");
        if (!data.workspaces || data.workspaces.length === 0) {
          setWorkspacePlaceholder("No workspaces found");
          return;
        }
        s.innerHTML = '<option value="">Select workspace</option>';
        data.workspaces.forEach(ws => {
          const o = document.createElement("option");
          o.value = ws.doc_id;
          o.textContent = ws.doc_id;
          s.appendChild(o);
        });
        s.disabled = false;
      } catch (e) {
        setWorkspacePlaceholder("Connection failed");
        console.error(e);
      }
    }

    async function loadWorkspace() {
      const apiKey = document.getElementById("apiKey").value.trim();
      const docId = document.getElementById("workspaceSelect").value;
      if (!apiKey) { setWorkspacePlaceholder("Enter API key"); resetWorkspaceView(); return; }
      if (!docId) { resetWorkspaceView(); return; }
      currentDocId = docId;
      document.getElementById("fileList").innerHTML = '<div class="file-list-empty">Loading files...</div>';
      try {
        const resp = await fetch(`/files/${docId}`, { headers: { "x-api-key": apiKey } });
        if (!resp.ok) {
          document.getElementById("fileList").innerHTML = '<div class="file-list-empty">Failed to load</div>';
          return;
        }
        const data = await resp.json();
        const el = document.getElementById("fileList");
        el.innerHTML = "";
        if (!data.files || data.files.length === 0) {
          el.innerHTML = '<div class="file-list-empty">No files in workspace</div>';
          return;
        }
        data.files.forEach((file, i) => {
          const div = document.createElement("div");
          div.className = "source-item";
          div.innerHTML = `<span class="source-icon"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></span><span class="source-name">${file}</span>`;
          div.onclick = () => loadFileContent(file, div);
          el.appendChild(div);
          if (i === 0) loadFileContent(file, div);
        });
      } catch (e) {
        document.getElementById("fileList").innerHTML = '<div class="file-list-empty">Failed to load</div>';
      }
    }

    async function loadFileContent(filename, element) {
      document.querySelectorAll(".source-item").forEach(el => el.classList.remove("active"));
      if (element) element.classList.add("active");
      currentFilename = filename;
      const container = document.getElementById("markdownContainer");
      try {
        const apiKey = document.getElementById("apiKey").value.trim();
        if (!apiKey || !currentDocId) return;
        const resp = await fetch(`/content/${currentDocId}?filename=${encodeURIComponent(filename)}`, {
          headers: { "x-api-key": apiKey }
        });
        if (!resp.ok) { container.innerHTML = '<div class="file-list-empty">Failed to load preview</div>'; return; }
        const data = await resp.json();
        container.innerHTML = marked.parse(data.content);
        container.scrollTop = 0;
      } catch (e) { container.innerHTML = '<div class="file-list-empty">Failed to load preview</div>'; }
    }

    /* ── Chat ── */
    function clearWelcome() {
      if (welcomeCleared) return;
      const w = document.querySelector('.chat-welcome');
      if (w) w.remove();
      welcomeCleared = true;
    }

    async function sendMessage() {
      const input = document.getElementById("questionInput");
      const text = input.value.trim();
      if (!text || !currentDocId) return;
      const apiKey = document.getElementById("apiKey").value.trim();
      if (!apiKey) {
        clearWelcome();
        addMessage("bot", "Please enter an API key in the header.");
        return;
      }

      clearWelcome();
      addMessage("user", text);
      input.value = "";
      input.style.height = 'auto';

      const loadingId = addThinking();
      const sendBtn = document.getElementById("sendBtn");
      sendBtn.disabled = true;

      try {
        const resp = await fetch("/query", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-api-key": apiKey },
          body: JSON.stringify({ doc_id: currentDocId, query: text })
        });
        removeMessage(loadingId);
        sendBtn.disabled = false;
        if (!resp.ok) { addMessage("bot", `Request failed (${resp.status})`); return; }
        const data = await resp.json();
        let answer = marked.parse(data.answer);
        answer = answer.replace(/\[([a-zA-Z0-9_\-\.\s:]+)\]/g, (match, content) => {
          let cleanId = content.replace(/^Source:\s*/i, '').trim();
          return `<span class="citation-link" onclick="scrollToReference('${cleanId}')">${match}</span>`;
        });
        addMessage("bot", answer, true);
      } catch (e) {
        removeMessage(loadingId);
        sendBtn.disabled = false;
        addMessage("bot", "Connection error: " + e.message);
      }
    }

    function addMessage(role, content, isHtml = false) {
      messageSeq++;
      const div = document.createElement("div");
      div.className = `message ${role}`;
      div.id = `msg-${messageSeq}-${Date.now()}`;
      if (isHtml) div.innerHTML = content; else div.textContent = content;
      document.getElementById("chatMessages").appendChild(div);
      div.scrollIntoView({ behavior: 'smooth', block: 'end' });
      return div.id;
    }

    function addThinking() {
      messageSeq++;
      const div = document.createElement("div");
      div.className = "message bot thinking";
      div.id = `msg-${messageSeq}-${Date.now()}`;
      div.innerHTML = '<div class="thinking-dots"><span></span><span></span><span></span></div>';
      document.getElementById("chatMessages").appendChild(div);
      div.scrollIntoView({ behavior: 'smooth', block: 'end' });
      return div.id;
    }

    function removeMessage(id) { document.getElementById(id)?.remove(); }

    window.scrollToReference = function(refId) {
      const panel = document.getElementById('sourcePanel');
      const items = document.querySelectorAll(".source-item");
      for (let item of items) {
        const name = item.querySelector('.source-name');
        const text = name ? name.textContent : item.textContent;
        if (text.includes(refId) || refId.includes(text.trim())) {
          item.click();
          break;
        }
      }
      panel.classList.remove('flash-active');
      void panel.offsetWidth;
      panel.classList.add('flash-active');
    };

    /* ── Init ── */
    setWorkspacePlaceholder("Enter API key to start");
  </script>
</body>
</html>
